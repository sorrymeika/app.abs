@using SL.Util
@{
    RequestUtil req = new RequestUtil();

    int userId = req.Int("userId", false, "参数错误:userId");
    string auth = req.String("auth", false, "参数错误:auth");
    string newAuth;

    if (req.HasError)
    {
        Json.Write(new { success = false, msg = req.FirstError, errors = req.GetErrors() }, Output);
    }
    else if (!AuthHelper.Check(userId, auth, out newAuth))
    {
        Json.Write(new { success = false, msg = "登录过期，请重新登录" }, Output);
    }
    else
    {
        using (SL.Data.Database db = SL.Data.Database.Open())
        {
            var data = db.QuerySingle("select XPS_START_FREE_DT,XPS_END_FREE_DT from XProspect where XPS_PSP_ID=@p0", userId);

            IList<Dictionary<string, object>> result = new List<Dictionary<string, object>>();
            Dictionary<string, object> currentMonth = null;

            if (data.XPS_END_FREE_DT != null && data.XPS_START_FREE_DT != null)
            {
                DateTime date;
                for (var i = data.XPS_START_FREE_DT; i < data.XPS_END_FREE_DT;)
                {
                    date = i.AddMonths(1);

                    var monthDiff = DateUtil.MonthDiff(i, DateTime.Today);

                    if (Math.Abs(monthDiff) <= 12)
                    {
                        var item = new Dictionary<string, object>();

                        var free = db.QuerySingle("select Top 1 FRE_NAME,FRE_TITLE_PIC,FRE_PIC1,LPF_PUR_ID from WFree join LFreCnl on LFC_FRE_ID=FRE_ID left join (select LPF_PUR_ID,LPF_FRE_ID from LPspFre where LPF_PSP_ID=@p0) a on LPF_FRE_ID=FRE_ID where FRE_FRT_ID=1 and LFC_CNL_ID=1 and @p1 between LFC_START_TIME and LFC_END_TIME", userId, i);

                        if (free != null)
                        {
                            item.Add("FRE_NAME", free.FRE_NAME);
                            item.Add("FRE_TITLE_PIC", free.FRE_TITLE_PIC);
                            item.Add("FRE_PIC1", free.FRE_PIC1);
                            item.Add("LPF_PUR_ID", free.LPF_PUR_ID);
                        }
                        else
                        {
                            item.Add("FRE_PIC1", null);
                        }

                        if (result.FirstOrDefault(a => a.ContainsKey("Year") && (int)a["Year"] == i.Year) == null)
                        {
                            item.Add("Year", i.Year);
                        }
                        item.Add("Month", i.Month);

                        item.Add("CanGet", monthDiff == 0 && free != null && free.LPF_PUR_ID == null);

                        if (monthDiff < 0)
                        {
                            item.Add("Overdue", true);
                        }
                        else if (monthDiff == 0)
                        {
                            currentMonth = item;
                        }
                        result.Add(item);
                    }
                    i = date;
                }

            }
            else
            {
            }

            Json.Write(new { success = true, auth = newAuth, data = result, currentMonth = currentMonth }, Output);
        }
    }
}

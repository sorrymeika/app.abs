<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        body, html { width: 100%; height: 100%; margin: 0; font-family: "微软雅黑"; }
        #allmap { width: 100%; height: 300px; }
        p { margin-left: 5px; font-size: 14px; }
        .shoplist { padding: 10px; }
        .shoplist > li { line-height: 1.5; border-bottom: 1px solid #ddd; padding: 10px; }
        .shoplist > li > b { font-size: 16px; display: block; padding-bottom: 5px; }
        .shoplist > li > span { font-size: 13px; display: block; }
        ul, li { list-style: none; }
    </style>
    <script type="text/javascript" src="http://api.map.baidu.com/api?type=quick&ak=ruKePGl5aEpASfCZtQm6a2U5&v=1.0"></script>
</head>
<body>
    <div id="allmap"></div>
    <ul class="js_shoplist shoplist"></ul>
</body>
</html>
<script>
    var post = function (url, data, callback) {
        if (typeof data === 'function') callback = data, data = null;

        var xhr = new XMLHttpRequest();
        if (!data)
            xhr.open('GET', url, true);
        else {
            xhr.open('POST', url, true);
            if (typeof data !== "string") {
                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                var post = [];
                for (var k in data) {
                    post.push(k + '=' + encodeURIComponent(data[k]))
                }
                data = post.join('&');
            } else {

                xhr.setRequestHeader("Content-Type", "application/json");
            }
        }

        xhr.onreadystatechange = function (e) {
            if (this.readyState == 4 && this.status == 200) {
                callback(JSON.parse(this.responseText));
            }
        };
        xhr.send(data);
    };
</script>
<script type="text/javascript">
    // 百度地图API功能
    var map = new BMap.Map("allmap");
    map.centerAndZoom(new BMap.Point(121.48789949, 31.24916171), 11);
    map.addControl(new BMap.ZoomControl());

    navigator.geolocation.getCurrentPosition(function (position) {
        var coords = position.coords;

        var point = new BMap.Point(coords.latitude, coords.longitude);
        map.centerAndZoom(point, 16);

    }, function (error) {
        //alert("定位失败");
    });

    post('/api/shop/shop_list', function (res) {
        if (res && res.data) {
            var html = "";
            for (var i = 0; i < res.data.length; i++) {
                var item = res.data[i];
                html += '<li><b>' + item.CNL_DESC + '</b><span>' + item.XCL_ADDRESS + '</span></li>'

                var myGeo = new BMap.Geocoder();
                // 将地址解析结果显示在地图上,并调整地图视野
                myGeo.getPoint(item.XCL_ADDRESS, function (point) {
                    if (point) {
                        var marker1 = new BMap.Marker(point, {
                            icon: new BMap.Icon('http://web.wx.abs.cn/images/store/abslogo.png', new BMap.Size(23, 28)),
                            offset: new BMap.Size(-13, -15)
                        });  //创建标注
                        map.addOverlay(marker1);                 // 将标注添加到地图中
                        //创建信息窗口
                        var infoWindow1 = new BMap.InfoWindow(item.CNL_DESC + "<br>" + item.XCL_ADDRESS);
                        marker1.addEventListener("click", function () { this.openInfoWindow(infoWindow1); });
                        map.centerAndZoom(point, 16);
                    }
                }, item.CTY_DESC);
            }

            document.querySelector('.js_shoplist').innerHTML = html;
        }

    });
</script>
